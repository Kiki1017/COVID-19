---
title: 'Schätzer für Deutschland basierend auf RKI Daten'
output: html_document
---

```{r libraries, echo = F, message = F, warning = F, results='hide'}
library(lubridate, warn.conflicts = F)
library(plotly, warn.conflicts = F)
Sys.setlocale('LC_TIME', 'C')
source("plot.r")
source("estimator.r")
```

```{r data, echo = F}
germany <- read.csv("data/clean/data_ger_bundl.csv")
```

```{r plots, echo = F, cache = F, message = F}

```

## {.tabset .tabset-fade}

[zurück](index.html)

<!--
See https://github.com/rstudio/flexdashboard/issues/80#issuecomment-247139450
on generating tabs in rmarkdown automatically
-->
```{r, echo = F, warning = F, message = F}

# add all of Germany to data
ger <- aggregate(cbind(tot.cases, tot.dead, new.cases, new.dead)
                 ~ day + yday + date, germany, sum)
ger$reg0.name <- "Deutschland"
germany <- merge(ger, germany, all=TRUE)

# tabs for Bundeslaender (and all Germany) sorted by tot.cases
maxday <- max(germany$day)
regions <- subset(germany, day == maxday, select = c(reg0.name, tot.cases))
regions <- regions[rev(order(regions$tot.cases)),]
regions <- regions$reg0.name
names(regions) <- regions

plots <- lapply(regions, function(country_name) {
    country <- germany %>%
        filter(reg0.name == country_name) %>%
        mutate(date = ymd(date))

    estimates <- cbind(country, repronum(
            new.cases = country$new.cases,
            profile = infectivity,
            window = width,
            delay = report.delay,
            conf.level = 1 - alpha,
            pad.zeros = TRUE
        ))
    
    plot_repronum(estimates, country_name, language = "de")
})

out <- lapply(seq_along(plots), function(i) {
  a1 <- knitr::knit_expand(text = sprintf("### %s\n", regions[i])) # tab header, auto extracts names of `hcs`
  a2 <- knitr::knit_expand(text = "\n```{r, echo = F, fig.width = 10}") # start r chunk
  a3 <- knitr::knit_expand(text = sprintf("\nplots[[%d]]", i)) # extract graphs by "writing" out `hcs[[1]]`, `hcs[[2]]` etc. to be rendered later
  a4 <- knitr::knit_expand(text = "\n```\n") # end r chunk

  paste(a1, a2, a3, a4, collapse = '\n') # collapse together all lines with newline separator
})
```

`r paste(knitr::knit(text = paste(out, collapse = '\n')))`

##

Erklärung (siehe [Technical Report]() für eine detaillierte Beschreibung):

- Wir schätzen die **Reproduktionsrate**  *R(t)* am Tag *t*, d. h. die durchschnittliche Anzahl von Menschen die jemand, der am Tag *t* infiziert wurde, infizieren würde, wenn die Bedingungen gleich bleiben würden.
- Der Schätzer wurde aus [(Fraser 2007)](#ref1) entnommen. Er vergleicht die Anzahl der Infektionen zu einem Zeitpunkt mit der Anzahl der infektiösen Fälle zu dieser Zeit gewichtet mit ihrer Infektivität.
- Für den Schätzer wurden (approximative, punktweise) **95% Konfidenzintervalle**, mit Hilfe der Delta-Methode, berechnet.
- **Warnung:** die Größe der Konfidenzintervalle spiegelt nur die statistische Unsicherheit wider, welche durch die zufällige Dynamik der Epidemie bedingt ist. Die obigen Schätzungen sollten vorsichtig interpretiert werden, da der Schätzer auf bestimmten Annahmen über die Infektivität des Virus basiert, zudem muss die Ungenauigkeit der zugrundeliegenden Daten beachtet werden, welche durch den Meldeablauf, die Anzahl der durchgeführten Tests etc. hinzu kommt. Speziell bei den RKI Daten wird das durch einen ausgeprägten Wochentagseffekt deutlich. Dennoch glauben wir daran, dass sich qualitative Aussagen ableiten lassen.
- Der Code steht [hier](https://github.com/Stochastik-TU-Ilmenau/COVID-19/blob/gh-pages/estimator.r) zur Verfügung.
- Der Schätzer wird in Schwarz angezeigt, Konfidenzbereiche als graue Streifen, wobei die Werte der (logarithmischen) Skala auf der linken Achse entsprechen.
- Der **kritische Wert** für die Reproduktionsrate ist **1**, angezeigt als horizontale Linie: ein Wert größer als Eins würde in einem exponentiellen Anstieg der Infektionen resultieren, einer kleiner als Eins zu einem Abfallen.
- Die Analyse basiert auf den **neu gemeldeten Fällen** der Coronavirus-Krankheit 2019 (COVID-19) pro Tag, angezeigt als blaue Säulen passend zur (linearen) Skala auf der rechten Achse. Die [Daten](https://npgeo-corona-npgeo-de.hub.arcgis.com/datasets/dd4580c810204019a7b8eb3e0b329dd6_0) stammen vom [Robert Koch-Institut](https://www.rki.de).
- Die Grafiken werden Täglich<!-- at 2:00 GMT--> aktualisiert und zeigen den Datenstand bis gestern.
- Zu beachten ist weiterhin, dass das Meldedatum der Fälle wesentlich später ist als das tatsächliche Infektionsdatum (Inkubationszeit, Durchführung der Tests und Meldung an die Behörden). Der Einfachheit halber gehen wir hier von einer Meldeverzögerung von 7 Tagen nach Infektion aus. Deswegen wird auch die Schätzung der Reproduktionsrate zeitversetzt zu den gemeldeten Fällen angezeigt!
- In einer Population in der keine Gegenmaßnahmen unternommen werden, wird die Reproduktionsrate des Coronavirus auf 2,4 bis 3,3 geschätzt. Schätzungen mit höheren Werten könnten dadurch erklärt werden, dass für eine bestimmte Region zu Beginn die meisten Fälle von außerhalb importiert wurden.


### Referenzen ###

<a name="ref1">[1]</a>: Fraser, C. (2007). *Estimating Individual and Household Reproduction
Numbers in an Emerging Epidemic.* PLOS ONE 2 (8), [https://doi.org/10.1371/journal.pone.0000758](https://doi.org/10.1371/journal.pone.0000758).
