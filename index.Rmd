---
title: 'Estimating reproduction rates over time for monitoring the spread of COVID-19'
output: html_document
---

```{r libraries, echo = F, message = F, warning = F, results='hide'}
library(lubridate, warn.conflicts = F)
library(plotly, warn.conflicts = F)
library(ggplot2, warn.conflicts = F)
library(magrittr, warn.conflicts = F)
library(dplyr, warn.conflicts = F)
Sys.setlocale('LC_TIME', 'C')
source("plot.r")
source("estimator.r")

```

```{r data, echo = F}
johns_hopkins <- read.csv("data/clean/data_world_jh.csv")
#germany <- read.csv("data/clean/data_ger_bundl.csv")
```

## {.tabset .tabset-fade}

Created by
[Prof. Dr. Thomas Hotz](https://www.tu-ilmenau.de/stochastik/team/thomas-hotz/),
[Stefan Heyder](https://www.tu-ilmenau.de/stochastik/team/stefan-heyder/),
[Matthias Glock](https://www.tu-ilmenau.de/stochastik/team/matthias-glock/)
and [Sebastian Semper](https://www.tu-ilmenau.de/stochastik/team/sebastian-semper/)
of the
*[AG Stochastik](https://www.tu-ilmenau.de/stochastik/), [Technische Universität Ilmenau](https://www.tu-ilmenau.de/)*
<br/>
in collaboration with
[Prof. Dr. Alexander Krämer](https://ekvv.uni-bielefeld.de/pers_publ/publ/PersonDetail.jsp?personId=21463&lang=de)
and
[Anne Böhle](anne.boehle@uni-bielefeld.de)
of the
*[School of Public Health](https://www.uni-bielefeld.de/gesundhw/index.html), [Bielefeld University](https://www.uni-bielefeld.de/)*.


<!--
See https://github.com/rstudio/flexdashboard/issues/80#issuecomment-247139450
on generating tabs in rmarkdown automatically
-->
```{r, echo = F, warning = F, message = F}

maxday <- max(johns_hopkins$day)
df <- subset(johns_hopkins, day == maxday, select = c(reg0.name, tot.cases))
df <- df[rev(order(df$tot.cases)),]
countries <- df$reg0.name[1:21]

#countries <- c("Germany", "Italy", "Spain", "France", "Switzerland", "Netherlands", "Austria", "United Kingdom", "Korea, South", "US")
names(countries) <- countries

plots <- lapply(countries, function(country_name) {
    country <- johns_hopkins %>%
        filter(reg0.name == country_name) %>%
        mutate(date = ymd(date))

    estimates <- cbind(country, repronum(
            new.cases = country$new.cases,
            profile = infectivity,
            window = width,
            delay = report.delay,
            conf.level = 1 - alpha,
            pad.zeros = TRUE
        ))

    plot_repronum(estimates, country_name, language = "en")
})

out <- lapply(seq_along(plots), function(i) {

  a1 <- knitr::knit_expand(text = sprintf("### %s\n", countries[i])) # tab header, auto extracts names of `hcs`
  a2 <- knitr::knit_expand(text = "\n```{r, echo = F, fig.width = 10}") # start r chunk
  a3 <- knitr::knit_expand(text = sprintf("\nplots[[%d]]", i)) # extract graphs by "writing" out `hcs[[1]]`, `hcs[[2]]` etc. to be rendered later
  a4 <- knitr::knit_expand(text = "\n```\n") # end r chunk

  paste(a1, a2, a3, a4, collapse = '\n') # collapse together all lines with newline separator
})

```

`r paste(knitr::knit(text = paste(out, collapse = '\n')))`

##

Explanations (see the [Technical Report]() for details):

- We estimate the **reproduction number** *R(t)* at day *t*, i.e. the average number of people someone infected at time *t* would infect if conditions remained the same.
- The estimator has been taken from [(Fraser 2007)](#ref1). It compares the number of infections at a time point with the number of infectious cases at that time, weighted by their respective infectivity.
- For this estimator, we derived (approximate, pointwise) **95% confidence intervals** using the delta method.
- However, the size of the confidence intervals reflects only those statistical uncertainties due to the random dynamics of the epidemic. But since the estimator is based on assumptions about the infectivity of the virus, and given that the data are not perfect because of a change of reporting criteria, the amount of testing etc., the estimates should be cautiously interpreted and not be taken at face value. Still, we believe that one can draw qualitatively credible conclusions from them.
- The code is avalaible [here](https://github.com/Stochastik-TU-Ilmenau/COVID-19/blob/gh-pages/estimator.r).
- Estimates are shown in black, confidence intervals as grey stripes, with values in accordance with the left axis (on a log-scale).
- The **critical value** for the reproduction number is 1, shown as a red horizontal line: a value larger than one would result in an exponential increase of infections, a value smaller than one in a decrease.
- The analysis is based on **newly reported cases** of Coronavirus Disease 2019 (COVID-19) per day, shown as blue bars in accordance with the right axis (on a linear scale). For these we rely on the data provided by [Johns Hopkins University](https://github.com/CSSEGISandData/COVID-19).
- The graphics are updated daily<!-- at 2:00 GMT-->, showing data up to yesterday.
- Note that cases are reported much later than the corresponding day of infection, namely after incubation time plus some more days necessary for testing and reporting the case to the authorities. For simplicity we assume that cases are reported 7 days after infection. Therefore, estimates for the reproduction number lag one week behind the reporting of new cases.
- In a population where no countermeasures have been put into place, the reproduction number is believed to be given by some value between 2.4 and 3.3. Estimates higher than that might be explained by a considerable number of imported cases before the day being considered.

### References ###

<a name="ref1">[1]</a>: Fraser, C. (2007). *Estimating Individual and Household Reproduction
Numbers in an Emerging Epidemic.* PLOS ONE 2 (8), [https://doi.org/10.1371/journal.pone.0000758](https://doi.org/10.1371/journal.pone.0000758).
